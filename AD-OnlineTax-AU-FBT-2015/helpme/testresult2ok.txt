^Conline@OnlineTax-L1:~/webdriverio-test/AD-OnlineTax-AU-FBT-2015/spec/ui$ mochaBTForm2.cjspec.js


  TaxOnlineTest
Title was: MYOB Account - Sign in
    ✓ SecurityPage (5815ms)
Title was: Practice Online
URL was: function () {

        var self = this,
            args = array_slice(arguments),
            deferred = Q.defer(),
            hasErrorHandling = false,
            callback;

        /**
         * get custom callback
         * exception for the execute command which can have a single function as param
         */
        if(typeof args[args.length - 1] === 'function' && (fnName.indexOf('execute') === -1 || args.length > 1)) {
            callback = args.pop();
        }

        var resolvePromise = function(promise, onFulfilled, onRejected, onFinalised) {
            var result = promise.inspect(),
                responseMethod = function() {},
                args;

            self.result = result;

            /**
             * protocol commands return single result, action commands
             * return result and response value as array
             */
            if(typeof result.value !== 'undefined' && !(result.value instanceof Array)) {
                result.value = [result.value];
            }

            /**
             * handle promise result according to state
             */
            if(result.state === 'fulfilled' && onFulfilled) {
                args = result.value;
                responseMethod = onFulfilled;
            } else if(result.state === 'rejected' && onRejected) {
                args = [result.reason];
                responseMethod = onRejected;
            } else if(!onFulfilled && !onRejected && onFinalised) {
                args = result.state === 'fulfilled' ? [undefined].concat(result.value) : [result.reason];
                responseMethod = onFinalised;
            }

            /**
             * execute response method on next tick to prevent loosing error
             */
            process.nextTick(function() {
                var returnPromise = responseMethod.apply(self, args);

                /**
                 * queue up next "then" if existing
                 */
                if(returnPromise && returnPromise.then) {
                    lastThenable.push(returnPromise.getPromise ? returnPromise.getPromise() : returnPromise);
                } else if(typeof returnPromise !== 'undefined') {
                    var newDeferred = Q.defer();
                    lastThenable.push(newDeferred.promise);
                    newDeferred.resolve(returnPromise);
                }
            });

        };

        var handlePromise = function(onFulfilled, onRejected, onFinalised) {
            return self.call(function() {
                /**
                 * run new promise queue
                 */
                if(fnName !== 'call') {
                    lastThenable = [];
                }

                var promise = fnName === 'call' ? lastThenable.shift() || deferred.promise : deferred.promise || lastThenable.shift();
                promise.finally(resolvePromise.bind(self, promise, onFulfilled, onRejected, onFinalised));
            });
        }

        this.then = this.thenResolve = function(onFulfilled, onRejected) {
            if(typeof onRejected === 'function') {
                hasErrorHandling = true;
            }

            return handlePromise(onFulfilled, onRejected);
        };

        this.catch = this.fail = this.thenReject = function(onRejected) {
            hasErrorHandling = true;
            return handlePromise(null, onRejected);
        };

        this.finally = this.fin = this.done = function(onFinalised) {
            return handlePromise(null, null, onFinalised);
        };

        this.inspect = function() {
            return deferred.promise.inspect();
        };

        this.getPromise = function() {
            return deferred.promise;
        };

        /**
         * in order to prevent a clean order of callback/promise
         * execution we need to resolve the promise in the same
         * event loop as the callback execution.
         * see Q.makeNodeResolver https://github.com/kriskowal/q/blob/v1/q.js#L615
         */
        args.push(function(error, value) {
            var newArgs = array_slice(arguments);
            if(callback) {
                callback.apply(self, newArgs);
            } else if(error && !hasErrorHandling && self.eventHandler.listeners('error').length < 2) {
                throw error;
            }

            if (error) {
                deferred.reject(error);
            } else if (arguments.length > 2) {
                deferred.resolve(array_slice(arguments, 1));
            } else {
                deferred.resolve(value);
            }
        });

        return fn.apply(this, args);

    }
    ✓ MYOB Account - Sign in (10302ms)
Tasks
Accounting
Documents
    ✓ Smoke (4366ms)
Add FBT Return
    ✓ Tax - Add FBT Return (9428ms)
undefined
    1) Tax - Create FBT Return
successfully entered the TFN
successfully entered the ABN
successfully entered the data of the business details tab
